<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°éœ‡æƒ…å ±ã‚¢ãƒ—ãƒª</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/ewc.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/ewc.png">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        header {
            width: 100%;
            background-color: #ffffff;
            color: #333333;
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        main {
            width: 100%;
            max-width: 800px;
            margin: 20px;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 12px;
        }
        #earthquakeInfo, #eewInfo {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            background-color: #fafafa;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 16px;
        }
        button {
            display: block;
            padding: 8px 16px;
            margin-top: 10px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #005bb5;
        }
    </style>
</head>
<body>
    <header>
        <h1>åœ°éœ‡æƒ…å ±ã‚¢ãƒ—ãƒª</h1>
        <p>ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä¿®æ­£ã‚’è¡Œã„ã¾ã—ãŸ</p>
        <button id="subscribeButton">é€šçŸ¥ã‚’è¨±å¯</button>
        <button id="testNotificationButton">ãƒ†ã‚¹ãƒˆé€šçŸ¥</button>
        <button class="scroll-button" onclick="scrollToEewSection()">ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã¸</button>
      <button id="reloadButton">å†èª­ã¿è¾¼ã¿ğŸ”ƒ</button>
    </header>
    <main>
        <div id="earthquakeInfo">åœ°éœ‡æƒ…å ±ã‚’å–å¾—ä¸­...</div>
        <div id="eewInfo">ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã‚’å–å¾—ä¸­...</div>
    </main>

    <script>
      
        const publicVapidKey = 'BC1T1-o4f9vLJ11ngQXOZTdKY8xd38vUyWeWyPosJ7JDJxnCPrAGtJZE_CUW4dqdh60eEUf5G-qzWjaojsSMer0';

        async function subscribe() {
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.register('/service-worker.js');
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
                });

                await fetch('/subscribe', {
                    method: 'POST',
                    body: JSON.stringify(subscription),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                alert('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼');
            } else {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
            }
        }

        async function sendTestNotification() {
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    const options = {
                        body: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆé€šçŸ¥ã§ã™ã€‚',
                        icon: '/icon.png'
                    };
                    registration.showNotification('ãƒ†ã‚¹ãƒˆé€šçŸ¥', options);
                } else {
                    alert('ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                }
            } else {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
            }
        }

        document.getElementById('subscribeButton').addEventListener('click', () => {
            subscribe().catch(err => console.error(err));
        });

        document.getElementById('testNotificationButton').addEventListener('click', () => {
            sendTestNotification().catch(err => console.error(err));
        });
      document.getElementById('reloadButton').addEventListener('click', () => {
    location.reload();
});

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function fetchEarthquakeInfo() {
            try {
                const response = await fetch('https://api.p2pquake.net/v2/history?codes=551&limit=5');
                const data = await response.json();
                displayEarthquakeInfo(data);
            } catch (error) {
                console.error('Error fetching earthquake information:', error);
            }
        }

        async function fetchEewInfo() {
            try {
                const response = await fetch('https://api.wolfx.jp/jma_eew.json');
                const data = await response.json();
                displayEewInfo(data);
            } catch (error) {
                console.error('Error fetching EEW information:', error);
            }
        }

        function displayEarthquakeInfo(earthquakes) {
    const container = document.getElementById('earthquakeInfo');
    container.innerHTML = '';
    earthquakes.forEach((earthquake, index) => {
        const time = new Date(earthquake.earthquake.time);
        const date = time.toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' });
        const timeStr = time.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

        const hypocenter = earthquake.earthquake.hypocenter.name;
        const maxScale = getScaleDescription(earthquake.earthquake.maxScale);
        let magnitude = earthquake.earthquake.hypocenter.magnitude;
        let depth = earthquake.earthquake.hypocenter.depth;

        depth = depth === -1 ? 'ä¸æ˜' : depth === 0 ? 'ã”ãæµ…ã„' : `ç´„${depth}km`;
        magnitude = magnitude === -1 ? 'ä¸æ˜' : magnitude.toFixed(1);

        const pointsByScale = groupPointsByScale(earthquake.points);
        const tsunamiInfo = getTsunamiInfo(earthquake.earthquake.domesticTsunami);
        const freeFormComment = earthquake.comments?.freeFormComment || '';

        let formattedMessage;

        if (earthquake.issue && earthquake.issue.type === 'ScalePrompt') {
            formattedMessage = `[éœ‡åº¦é€Ÿå ±]\n${date} ${timeStr}ã”ã‚ã€åœ°éœ‡ã«ã‚ˆã‚‹å¼·ã„æºã‚Œã‚’æ„Ÿã˜ã¾ã—ãŸã€‚éœ‡åº¦ï¼“ä»¥ä¸ŠãŒè¦³æ¸¬ã•ã‚ŒãŸåœ°åŸŸã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚\n`;

            Object.keys(pointsByScale).sort((a, b) => b - a).forEach(scale => {
                formattedMessage += `\nã€Šéœ‡åº¦${scale}ã€‹`;
                Object.keys(pointsByScale[scale]).forEach(pref => {
                    formattedMessage += `\nã€${pref}ã€‘${pointsByScale[scale][pref].join('  ')}`;
                });
            });
        } else {
            formattedMessage = `[åœ°éœ‡æƒ…å ±]\n${date} ${timeStr}é ƒ\néœ‡æºåœ°ï¼š${hypocenter}\næœ€å¤§éœ‡åº¦ï¼š${maxScale}\næ·±ã•ï¼š${depth}\nè¦æ¨¡ï¼šM${magnitude}\n${tsunamiInfo}\n\nï¼»å„åœ°ã®éœ‡åº¦ï¼½`;

            const scaleOrder = ['7', '6å¼·', '6å¼±', '5å¼·', '5å¼±','5å¼±ä»¥ä¸Šã¨æ¨å®šã•ã‚Œã‚‹ãŒéœ‡åº¦æƒ…å ±ã‚’å…¥æ‰‹ã—ã¦ã„ãªã„', '4', '3', '2', '1'];
            const sortedScales = Object.keys(pointsByScale).sort((a, b) => {
                return scaleOrder.indexOf(a) - scaleOrder.indexOf(b);
            });

            sortedScales.forEach(scale => {
                formattedMessage += `\nã€Šéœ‡åº¦${scale}ã€‹`;
                Object.keys(pointsByScale[scale]).forEach(pref => {
                    const uniqueCities = new Set();
                    pointsByScale[scale][pref].forEach(addr => {
                        uniqueCities.add(addr); // ä¿®æ­£å¾Œã®å¸‚åŒºç”ºæ‘åã‚’åˆ©ç”¨
                    });
                    formattedMessage += `\nã€${pref}ã€‘${Array.from(uniqueCities).join('  ')}`;
                });
            });

            if (freeFormComment) {
                formattedMessage += `\n\nã€æƒ…å ±ã€‘\n${freeFormComment}`;
            }
        }
                const earthquakeInfo = document.createElement('div');
                earthquakeInfo.innerHTML = `
                    <p>${formattedMessage.replace(/\n/g, '<br>')}</p>
                    
                    <textarea id="editedMessage${index}" placeholder="é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†" style="width: 100%; height: 150px;">${formattedMessage}</textarea>
                    <button onclick="shareEditedMessage(${index})">ç·¨é›†ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…±æœ‰</button>
                `;
                container.appendChild(earthquakeInfo);
            });
        }

        function displayEewInfo(data) {
            const container = document.getElementById('eewInfo');
            container.innerHTML = '';
            if (data.Title && data.CodeType) {
                let formattedMessage;
                if (data.isCancel) {
                    formattedMessage = "å…ˆç¨‹ã®ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã¯å–ã‚Šæ¶ˆã•ã‚Œã¾ã—ãŸã€‚";
                } else {
                    formattedMessage = formatEewMessage(data);
                    if (data.isAssumption) {
                        formattedMessage += "\nâ€»ã“ã®ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã¯ç²¾åº¦ãŒä½ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™â€»";
                    }
                }

                const eewInfo = document.createElement('div');
                eewInfo.innerHTML = `
                    <p>${formattedMessage.replace(/\n/g, '<br>')}</p>
                    //<textarea id="eewComment" placeholder="è‡ªä½œç·Šæ€¥åœ°éœ‡é€Ÿå ±æ–‡"></textarea>
                    //<button onclick="shareEewComment()">è‡ªä½œæƒ…å ±æ–‡ã‚’å…±æœ‰</button>
                    <textarea id="editedEewMessage" placeholder="é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†" style="width: 100%; height: 150px;">${formattedMessage}</textarea>
                    <button onclick="shareEditedEewMessage()">ç·¨é›†ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…±æœ‰</button>
                `;
                container.appendChild(eewInfo);
            }
        }

        function formatEewMessage(data) {
            return `ã€${data.Title} æ¨å®šæœ€å¤§éœ‡åº¦${data.MaxIntensity}ã€‘\n(ç¬¬${data.Serial}å ±)\n${data.OriginTime.split(' ')[1]}é ƒã€${data.Hypocenter}ã‚’éœ‡æºã¨ã™ã‚‹åœ°éœ‡ãŒã‚ã‚Šã¾ã—ãŸã€‚åœ°éœ‡ã®è¦æ¨¡ã¯M${data.Magunitude}ç¨‹åº¦ã€éœ‡æºã®æ·±ã•ã¯ç´„${data.Depth}kmã€æœ€å¤§éœ‡åº¦${data.MaxIntensity}ç¨‹åº¦ã¨æ¨å®šã•ã‚Œã¦ã„ã¾ã™ã€‚`;
        }

        function getScaleDescription(scale) {
            const scaleDescriptions = {
                10: '1',
                20: '2',
                30: '3',
                40: '4',
                45: '5å¼±',
                46: '5å¼±ä»¥ä¸Šã¨æ¨å®šã•ã‚Œã‚‹ãŒéœ‡åº¦æƒ…å ±ã‚’å…¥æ‰‹ã—ã¦ã„ãªã„',
                50: '5å¼·',
                55: '6å¼±',
                60: '6å¼·',
                70: '7'
            };
            return scaleDescriptions[scale] || 'ä¸æ˜';
        }

function groupPointsByScale(points) {
    const pointsByScale = {};

    points.forEach(point => {
        const scale = getScaleDescription(point.scale);
        let addr = point.addr;
        const prefecture = point.pref;

        if (!scale) return;

        // STEP 1: å¸‚åŒºç”ºæ‘ã§åˆ‡ã‚Šå‡ºã™
        let originalAddr = addr; // å…ƒã®ã‚¢ãƒ‰ãƒ¬ã‚¹
        const cityMatch = addr.match(/([^å¸‚åŒºç”ºæ‘]+[å¸‚åŒºç”ºæ‘])/);
        if (cityMatch) {
            addr = cityMatch[1];
        }
        console.log(`åˆ‡ã‚Šå‡ºã—å‰: ${originalAddr}, åˆ‡ã‚Šå‡ºã—å¾Œ: ${addr}`);

        // STEP 2: ç‰¹å®šã®å¸‚åŒºç”ºæ‘åã‚’ä¿®æ­£ã™ã‚‹
        const cityAdjustments = {
            "å¤§ç”º": "å¤§ç”ºå¸‚",
            "å¸‚è²": "å¸‚è²ç”º",
            "ç”°æ‘": "ç”°æ‘å¸‚",
            "å¸‚å·": "å¸‚å·å¸‚",
            "ç”ºç”°": "ç”ºç”°å¸‚",
            "å¸‚åŸ": "å¸‚åŸå¸‚"
        };

        if (cityAdjustments[addr]) {
            console.log(`ä¿®æ­£å‰: ${addr}`);
            addr = cityAdjustments[addr];
            console.log(`ä¿®æ­£å¾Œ: ${addr}`);
        }

        // STEP 3: pointsByScaleã«è¿½åŠ 
        pointsByScale[scale] = pointsByScale[scale] || {};
        pointsByScale[scale][prefecture] = pointsByScale[scale][prefecture] || [];
        pointsByScale[scale][prefecture].push(addr);
    });

    return pointsByScale;
}
        function getTsunamiInfo(domesticTsunami) {
            const tsunamiMessages = {
                "None": "ã“ã®åœ°éœ‡ã«ã‚ˆã‚‹æ´¥æ³¢ã®å¿ƒé…ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
                "Unknown": "ä¸æ˜",
                "Checking": "æ´¥æ³¢ã®æœ‰ç„¡ã‚’èª¿æŸ»ä¸­ã§ã™ã€‚ä»Šå¾Œã®æƒ…å ±ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚",
                "NonEffective": "è‹¥å¹²ã®æµ·é¢å¤‰å‹•ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€è¢«å®³ã®å¿ƒé…ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
                "Watch": "ç¾åœ¨ã€æ´¥æ³¢æ³¨æ„å ±ã‚’ç™ºè¡¨ä¸­ã§ã™ã€‚",
                "Warning": "æ´¥æ³¢è­¦å ±ç­‰ï¼ˆå¤§æ´¥æ³¢è­¦å ±ãƒ»æ´¥æ³¢è­¦å ±ã‚ã‚‹ã„ã¯æ´¥æ³¢æ³¨æ„å ±ï¼‰ã‚’ç™ºè¡¨ä¸­ã§ã™ã€‚"
            };
            return tsunamiMessages[domesticTsunami] || "ï¼ˆæ´¥æ³¢æƒ…å ±ãªã—ï¼‰";
        }

        function shareComment(index) {
            const comment = document.getElementById(`comment${index}`).value;
            if (navigator.share) {
                navigator.share({
                    title: 'è‡ªä½œåœ°éœ‡æƒ…å ±æ–‡',
                    text: comment
                }).catch(console.error);
            } else {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å…±æœ‰æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
            }
        }

        function shareEditedMessage(index) {
            const editedMessage = document.getElementById(`editedMessage${index}`).value;
            if (navigator.share) {
                navigator.share({
                    title: 'åœ°éœ‡æƒ…å ±',
                    text: editedMessage
                }).catch(console.error);
            } else {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å…±æœ‰æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
            }
        }

        function shareEewComment() {
            const comment = document.getElementById('eewComment').value;
            if (navigator.share) {
                navigator.share({
                    title: 'è‡ªä½œç·Šæ€¥åœ°éœ‡é€Ÿå ±æ–‡',
                    text: comment
                }).catch(console.error);
            } else {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å…±æœ‰æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
            }
        }

        function shareEditedEewMessage() {
            const editedMessage = document.getElementById('editedEewMessage').value;
            if (navigator.share) {
                navigator.share({
                    title: 'ç·Šæ€¥åœ°éœ‡é€Ÿå ±',
                    text: editedMessage
                }).catch(console.error);
            } else {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å…±æœ‰æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
            }
        }

        function scrollToEewSection() {
            const eewSection = document.getElementById('eewInfo');
            eewSection.scrollIntoView({ behavior: 'smooth' });
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchEarthquakeInfo();
            fetchEewInfo();
        });
    </script>
</body>
</html>
